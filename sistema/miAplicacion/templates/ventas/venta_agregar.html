<form method="post" id="venta-form">
    {% csrf_token %}
    {{ venta_form.as_p }}
    <!--<form method="post">: Define un formulario HTML que utilizará el método POST para enviar datos al servidor.
    {% csrf_token %}: Es un token de seguridad utilizado en Django para prevenir ataques CSRF (Cross-Site Request Forgery).
    {{ venta_form.as_p }}: Renderiza el formulario de Django en formato HTML. Este campo está conectado al modelo de ventas en el backend.-->
    
    
    <table id="productos-table">
        <!--Tabla de productos: Contiene una tabla que permite seleccionar productos,
        ver sus precios, ingresar cantidades, y calcular el importe correspondiente de cada producto.-->
        <thead>
            <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Importe</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="productos-body">
            <tr class="fila-producto">
                <td>
                    <select name="producto[]" class="producto-input">
                        {% for producto in productos %}
                            <option value="{{ producto.id }}" data-precio="{{ producto.precio }}">{{ producto.nombre }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td><input type="text" class="precio-input" readonly></td>
                <td><input type="number" name="cantidad[]" class="cantidad-input" value="1" min="1"></td>
                <td><input type="text" class="importe-input" readonly></td>
                <td><button type="button" class="btn-remove" style="display: none;">Eliminar</button></td>
            </tr>
        </tbody>
    </table>

    <h4>Total de la venta: <span id="total_importe">0.00</span></h4>

    <label for="monto_pago">Monto con el que paga el cliente:</label>
    <input type="number" id="monto_pago" name="monto_pago" step="0.01" min="0">

    <h4>Vuelto: <span id="vuelto">0.00</span></h4>
    <h4>Falta: <span id="falta">0.00</span></h4> <!-- Nueva línea para mostrar cuánto falta -->

    <button type="button" id="add-producto-btn">Agregar Producto</button>
    <button type="submit">Terminar Venta</button>
    <button type="button" onclick="window.location.href='{% url 'venta_lista' %}'" class="btn btn-secondary">Atras</button>
</form>

<script>
function agregarEventosFila(fila) {
    const productoInput = fila.querySelector('.producto-input');
    const cantidadInput = fila.querySelector('.cantidad-input');
    const btnRemove = fila.querySelector('.btn-remove');

    productoInput.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const precio = selectedOption.getAttribute('data-precio');
        const precioInput = fila.querySelector('.precio-input');
        precioInput.value = parseFloat(precio).toFixed(2);
        actualizarImporte(fila);
        actualizarDisponibilidadProductos(); 
    });

    cantidadInput.addEventListener('input', function() {
        actualizarImporte(fila);
    });

    btnRemove.addEventListener('click', function() {
        fila.remove();
        actualizarTotal();
        actualizarDisponibilidadProductos(); 
    });
}

function actualizarImporte(fila) {
    const precio = parseFloat(fila.querySelector('.precio-input').value);
    const cantidad = parseInt(fila.querySelector('.cantidad-input').value);
    if (!isNaN(precio) && !isNaN(cantidad)) {
        const importe = precio * cantidad;
        fila.querySelector('.importe-input').value = importe.toFixed(2);
        actualizarTotal();
    }
}

function actualizarTotal() {
    let total = 0;
    const filasProductos = document.querySelectorAll('.fila-producto');
    filasProductos.forEach(fila => {
        const importe = parseFloat(fila.querySelector('.importe-input').value);
        if (!isNaN(importe)) {
            total += importe;
        }
    });
    document.getElementById('total_importe').textContent = total.toFixed(2);
    calcularVuelto();  // Recalcular el vuelto cuando se actualice el total
}

function actualizarDisponibilidadProductos() {
    const productosSeleccionados = [];
    document.querySelectorAll('.producto-input').forEach(select => {
        const selectedValue = select.value;
        if (selectedValue) {
            productosSeleccionados.push(selectedValue);
        }
    });

    document.querySelectorAll('.producto-input').forEach(select => {
        const opciones = select.querySelectorAll('option');
        opciones.forEach(opcion => {
            if (productosSeleccionados.includes(opcion.value) && opcion.value !== select.value) {
                opcion.disabled = true;
            } else {
                opcion.disabled = false;
            }
        });
    });
}

document.getElementById('add-producto-btn').addEventListener('click', function() {
    const productosBody = document.getElementById('productos-body');
    const nuevaFila = document.querySelector('.fila-producto').cloneNode(true);

    nuevaFila.querySelector('.precio-input').value = '';
    nuevaFila.querySelector('.cantidad-input').value = 1;
    nuevaFila.querySelector('.importe-input').value = '';

    nuevaFila.querySelector('.btn-remove').style.display = 'inline-block';

    agregarEventosFila(nuevaFila);

    productosBody.appendChild(nuevaFila);

    actualizarDisponibilidadProductos(); 
});

document.querySelectorAll('.fila-producto').forEach(fila => {
    agregarEventosFila(fila);
});

function calcularVuelto() {
    const total = parseFloat(document.getElementById('total_importe').textContent);
    const montoPago = parseFloat(document.getElementById('monto_pago').value);

    if (!isNaN(montoPago)) {
        if (montoPago >= total) {
            const vuelto = montoPago - total;
            document.getElementById('vuelto').textContent = vuelto.toFixed(2);
            document.getElementById('falta').textContent = "0.00";  // Si paga lo suficiente o más, no falta nada
        } else {
            const falta = total - montoPago;
            document.getElementById('falta').textContent = falta.toFixed(2);
            document.getElementById('vuelto').textContent = "0.00";  // Si falta, no hay vuelto
        }
    } else {
        document.getElementById('vuelto').textContent = "0.00";
        document.getElementById('falta').textContent = total.toFixed(2);  // Mostrar todo el total como faltante si no ha ingresado nada
    }
}

document.getElementById('monto_pago').addEventListener('input', calcularVuelto);
</script>






